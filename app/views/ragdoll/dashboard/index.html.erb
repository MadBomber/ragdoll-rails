<% content_for :title, "Dashboard - Ragdoll Engine" %>

<%= render Ragdoll::PageHeaderComponent.new(
  title: "Ragdoll Engine Dashboard",
  icon: "fas fa-tachometer-alt", 
  subtitle: "Overview of your document processing and search system"
) %>

<div class="row mb-4">
  <div class="col-md-3">
    <%= render Ragdoll::StatsCardComponent.new(
      title: "Documents",
      value: @stats[:total_documents],
      icon: "fas fa-file-alt",
      color: "primary",
      description: "Total documents"
    ) %>
  </div>
  <div class="col-md-3">
    <%= render Ragdoll::StatsCardComponent.new(
      title: "Processed",
      value: @stats[:processed_documents],
      icon: "fas fa-check-circle",
      color: "success",
      description: "Successfully processed"
    ) %>
  </div>
  <div class="col-md-3">
    <%= render Ragdoll::StatsCardComponent.new(
      title: "Embeddings",
      value: @stats[:total_embeddings],
      icon: "fas fa-vector-square",
      color: "info",
      description: "Vector embeddings"
    ) %>
  </div>
  <div class="col-md-3">
    <%= render Ragdoll::StatsCardComponent.new(
      title: "Searches",
      value: @stats[:total_searches],
      icon: "fas fa-search",
      color: "warning",
      description: "Total searches"
    ) %>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <%= render Ragdoll::CardComponent.new(title: "Document Types", icon: "fas fa-chart-pie") do %>
      <% if @document_types.any? %>
        <canvas id="documentTypesChart" width="400" height="200"></canvas>
      <% else %>
        <p class="text-muted">No documents yet. <%= link_to "Add your first document", ragdoll.new_document_path, class: "btn btn-primary btn-sm" %></p>
      <% end %>
    <% end %>
  </div>
  
  <div class="col-md-6">
    <%= render Ragdoll::CardComponent.new(title: "Most Searched Documents", icon: "fas fa-fire") do %>
      <% if @top_searched_documents.any? %>
        <% @top_searched_documents.each do |title, count| %>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-truncate"><%= title %></span>
            <span class="badge bg-primary"><%= count %></span>
          </div>
        <% end %>
      <% else %>
        <p class="text-muted">No search data yet. <%= link_to "Try searching", ragdoll.search_index_path, class: "btn btn-primary btn-sm" %></p>
      <% end %>
    <% end %>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-clock"></i> Recent Documents</h5>
      </div>
      <div class="card-body">
        <% if @recent_documents.any? %>
          <% @recent_documents.each do |document| %>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <%= link_to document.title, ragdoll.document_path(document), class: "text-decoration-none" %>
                <small class="text-muted d-block">
                  <%= document.document_type&.upcase %> • 
                  <%= render Ragdoll::StatusBadgeComponent.new(status: document.status) %>
                </small>
              </div>
              <small class="text-muted"><%= time_ago_in_words(document.created_at) %> ago</small>
            </div>
          <% end %>
          <div class="mt-3">
            <%= link_to "View all documents", ragdoll.documents_path, class: "btn btn-outline-primary btn-sm" %>
          </div>
        <% else %>
          <p class="text-muted">No documents yet. <%= link_to "Add your first document", ragdoll.new_document_path, class: "btn btn-primary btn-sm" %></p>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-history"></i> Recent Searches</h5>
      </div>
      <div class="card-body">
        <% if @stats[:recent_searches].any? %>
          <% @stats[:recent_searches].each do |search| %>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <a href="<%= ragdoll.search_index_path %>?search_id=<%= search.id %>" class="text-decoration-none">
                  <i class="fas fa-search me-1"></i><strong><%= search.query %></strong>
                </a>
                <small class="text-muted d-block">
                  <%= search.search_type.titleize %>
                  • <%= search.results_count %> results
                  <% if search.execution_time_ms %>
                    • <%= number_with_precision(search.execution_time_ms / 1000.0, precision: 3) %>s
                  <% end %>
                </small>
              </div>
              <small class="text-muted"><%= time_ago_in_words(search.created_at) %> ago</small>
            </div>
          <% end %>
          <div class="mt-3">
            <%= link_to "View search analytics", ragdoll.analytics_path, class: "btn btn-outline-primary btn-sm" %>
          </div>
        <% else %>
          <p class="text-muted">No searches yet. <%= link_to "Try searching", ragdoll.search_index_path, class: "btn btn-primary btn-sm" %></p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-tools"></i> Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <%= link_to ragdoll.new_document_path, class: "btn btn-primary w-100" do %>
              <i class="fas fa-plus"></i> Add Document
            <% end %>
          </div>
          <div class="col-md-3 mb-2">
            <%= link_to ragdoll.search_index_path, class: "btn btn-success w-100" do %>
              <i class="fas fa-search"></i> Search Documents
            <% end %>
          </div>
          <div class="col-md-3 mb-2">
            <%= link_to ragdoll.analytics_path, class: "btn btn-info w-100" do %>
              <i class="fas fa-chart-line"></i> View Analytics
            <% end %>
          </div>
          <div class="col-md-3 mb-2">
            <%= link_to ragdoll.configuration_path, class: "btn btn-warning w-100" do %>
              <i class="fas fa-cog"></i> Configuration
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @document_types.any? %>
<%= content_for :javascript do %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('documentTypesChart').getContext('2d');
  const documentTypesChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: <%= @document_types.keys.to_json.html_safe %>,
      datasets: [{
        data: <%= @document_types.values.to_json.html_safe %>,
        backgroundColor: [
          '#FF6384',
          '#36A2EB',
          '#FFCE56',
          '#4BC0C0',
          '#9966FF',
          '#FF9F40'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
});
</script>
<% end %>
<% end %>